name: Package and Upload to R2

on:
    push:
        branches:
            - main
    workflow_dispatch:

jobs:
    package-and-upload:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Create tarball
              run: |
                  # Get the branch/ref name and sanitize it for use as a filename
                  # Replace slashes with dashes (e.g., feature/abc -> feature-abc)
                  BRANCH_NAME="${GITHUB_REF#refs/heads/}"
                  SAFE_BRANCH_NAME=$(echo "${BRANCH_NAME}" | sed 's/\//-/g')
                  TARBALL_NAME="${SAFE_BRANCH_NAME}.tar.gz"
                  TARBALL_PATH="/tmp/${TARBALL_NAME}"

                  # Create tarball in /tmp to avoid "file changed as we read it" error
                  tar -czf "${TARBALL_PATH}" \
                    --exclude='.github' \
                    --exclude='.git' \
                    --exclude='node_modules' \
                    --exclude='dist' \
                    --exclude='.env' \
                    --exclude='.env.local' \
                    .

                  echo "TARBALL_PATH=${TARBALL_PATH}" >> $GITHUB_ENV
                  echo "Created tarball: ${TARBALL_NAME} from branch: ${BRANCH_NAME}"
                  ls -lh "${TARBALL_PATH}"

            - name: Configure AWS CLI for Cloudflare R2
              run: |
                  aws configure set aws_access_key_id ${{ secrets.R2_ACCESS_KEY_ID }}
                  aws configure set aws_secret_access_key ${{ secrets.R2_SECRET_ACCESS_KEY }}
                  aws configure set default.region auto

            - name: Upload to Cloudflare R2
              env:
                  R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
              run: |
                  # Extract just the filename from the path
                  TARBALL_NAME=$(basename "${TARBALL_PATH}")
                  
                  # Upload to R2 using S3-compatible endpoint
                  aws s3 cp "${TARBALL_PATH}" \
                    "s3://hercules-app-templates/${TARBALL_NAME}" \
                    --endpoint-url "https://${R2_ACCOUNT_ID}.r2.cloudflarestorage.com"

                  echo "âœ… Successfully uploaded ${TARBALL_NAME} to R2 bucket: hercules-app-templates"

            - name: Cleanup
              if: always()
              run: |
                  rm -f "${TARBALL_NAME}"
                  echo "Cleaned up tarball"
